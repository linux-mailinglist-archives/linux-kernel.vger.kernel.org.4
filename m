Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id F36D26F8CA4
	for <lists+linux-kernel@lfdr.de>; Sat,  6 May 2023 01:08:45 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230502AbjEEXIm (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Fri, 5 May 2023 19:08:42 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:60472 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229694AbjEEXIl (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 5 May 2023 19:08:41 -0400
Received: from dfw.source.kernel.org (dfw.source.kernel.org [139.178.84.217])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6A71D3C27;
        Fri,  5 May 2023 16:08:40 -0700 (PDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by dfw.source.kernel.org (Postfix) with ESMTPS id 068CA64089;
        Fri,  5 May 2023 23:08:40 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 33B49C433EF;
        Fri,  5 May 2023 23:08:35 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1683328119;
        bh=E9xVrGcyPpQiErxL+lGa0x3zhKoFQlcP5X0surPTEkc=;
        h=From:To:Cc:Subject:Date:From;
        b=AIIVx1GrhOuJmOOGM/1DuuArum/V7qVHzZHXd3ehNcStcCrVbQA+zJumI4eIzp6Vn
         hdPGCJPKYwuFm5fcC/2sU9VBaLkWsEUT+LV/17BnIhp5D5sNpUoZ1Fm8v6dEntuE+R
         mkBVuhoXNEyfUa3K5sHzORLva15diJPBmQXTy1sN8ignpjqPWSwUl6qQ6hWnEbj20h
         9qUfwRNUee6OaRZ/q/TJZ+L3gr+kne1RUdz7w6Do5bYh2AF5w4Bhr0I5J8Og4x6nzc
         +tn8dGJyKQj5D+plq3e7p7XD0Z7FGNf1DsSooKFchrZKKW4Gh9LNhcJuOvundqGOs5
         08S/9eqP71ffA==
From:   Arnaldo Carvalho de Melo <acme@kernel.org>
To:     Linus Torvalds <torvalds@linux-foundation.org>
Cc:     Ingo Molnar <mingo@kernel.org>,
        Thomas Gleixner <tglx@linutronix.de>,
        Jiri Olsa <jolsa@kernel.org>,
        Namhyung Kim <namhyung@kernel.org>,
        Clark Williams <williams@redhat.com>,
        Kate Carcia <kcarcia@redhat.com>, linux-kernel@vger.kernel.org,
        linux-perf-users@vger.kernel.org,
        Arnaldo Carvalho de Melo <acme@kernel.org>,
        Adrian Hunter <adrian.hunter@intel.com>,
        Changbin Du <changbin.du@huawei.com>,
        Hao Luo <haoluo@google.com>, Ian Rogers <irogers@google.com>,
        James Clark <james.clark@arm.com>,
        Kan Liang <kan.liang@linux.intel.com>,
        Roman Lozko <lozko.roma@gmail.com>,
        Stephane Eranian <eranian@google.com>,
        Thomas Richter <tmricht@linux.ibm.com>,
        Arnaldo Carvalho de Melo <acme@redhat.com>
Subject: [GIT PULL] perf tools changes for v6.4: 2nd attempt
Date:   Fri,  5 May 2023 20:08:31 -0300
Message-Id: <20230505230831.1084855-1-acme@kernel.org>
X-Mailer: git-send-email 2.39.2
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-Spam-Status: No, score=-7.3 required=5.0 tests=BAYES_00,DKIMWL_WL_HIGH,
        DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_HI,
        SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE autolearn=ham
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi Linus,

	Please see if this is now ok, otherwise holler and we'll try
again to address whatever problems remain,

Best regards,

- Arnaldo

The following changes since commit 1f85d016768ff19f060f3cce014a43c761de8259:

  perf test record+probe_libc_inet_pton: Fix call chain match on x86_64 (2023-05-03 11:02:21 -0300)

are available in the Git repository at:

  git://git.kernel.org/pub/scm/linux/kernel/git/acme/linux.git tags/perf-tools-for-v6.4-2-2023-05-05

for you to fetch changes up to 6c73f819b6b6d6f052e8dbe3f66f0693554ddf48:

  perf metrics: Fix SEGV with --for-each-cgroup (2023-05-05 19:18:55 -0300)

----------------------------------------------------------------
Additional fixes on top of the previous v6.4 perf tools pull request:

- Remove the use of bpftool to generate a vmlinux.h file to be used when
  building BPF bytecode that enables perf tools features.

  Instead add a vmlinux.h file with just the set of structs and fields
  used in the tools/perf/util/bpf_skel/*.bpf.c files and rely on libbpf's
  CO-RE functionality to compare the BTF info generated by clang for the
  BPF target against the BPF info for the kernel where the resulting tool
  runs to adjust it before loading into the kernel.

- Fix 'perf stat -b <prog id>' to match counter values obtained via
  'bpftool prog profile <prog id>', as fentry/fexit progs gets loaded,
  but the corresponding perf event wasn't being enabled and added into
  the events BPF map.

- Fix copy of 'perf stat' metric threshold to avoid SEGV on using
  uninitialized memory.

Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

----------------------------------------------------------------
Arnaldo Carvalho de Melo (1):
      perf bpf skels: Stop using vmlinux.h generated from BTF, use subset of used structs + CO-RE

Dmitrii Dolgov (1):
      perf stat: Separate bperf from bpf_profiler

Ian Rogers (1):
      perf metrics: Fix SEGV with --for-each-cgroup

 tools/perf/Makefile.perf            |  20 +----
 tools/perf/builtin-stat.c           |   4 +-
 tools/perf/util/bpf_skel/.gitignore |   1 -
 tools/perf/util/bpf_skel/vmlinux.h  | 173 ++++++++++++++++++++++++++++++++++++
 tools/perf/util/evsel.h             |   5 ++
 tools/perf/util/metricgroup.c       |   1 +
 6 files changed, 182 insertions(+), 22 deletions(-)
 create mode 100644 tools/perf/util/bpf_skel/vmlinux.h
