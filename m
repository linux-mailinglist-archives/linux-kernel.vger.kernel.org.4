Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 57DB970908A
	for <lists+linux-kernel@lfdr.de>; Fri, 19 May 2023 09:42:34 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230312AbjESHmH (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Fri, 19 May 2023 03:42:07 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59480 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230270AbjESHl7 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 19 May 2023 03:41:59 -0400
Received: from mail-pf1-x433.google.com (mail-pf1-x433.google.com [IPv6:2607:f8b0:4864:20::433])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4318A1712;
        Fri, 19 May 2023 00:41:33 -0700 (PDT)
Received: by mail-pf1-x433.google.com with SMTP id d2e1a72fcca58-64384c6797eso2309432b3a.2;
        Fri, 19 May 2023 00:41:33 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20221208; t=1684482093; x=1687074093;
        h=content-disposition:mime-version:message-id:subject:to:from:date
         :from:to:cc:subject:date:message-id:reply-to;
        bh=xz++8cp/MOfN7DhrMnTkQuFUltOrCffkRhgTguG3kA8=;
        b=PqaIy1xeFs1r7a7r4g+8W1WbHjHFnatSbr8Nq8PLwreNpDlco7i8/UhpB6kOJWAfLm
         x+uLudDuiQB0BwuTtGfE/gdyu/T84y0hKGkCCZpvSwAwFAzUHiuupoBOhnI03iLsgeIi
         FrhGGOTsmbVHd9uxMMv/ecVyzwm27NVaG2Nx4mviVB79vPL/CrT3z9YB13kAEKRfvJre
         tkRiwY6dPhnyNbd2wXHTPGYcHG4aHkM79Bz4jUPJZlKM7qx6truEDnYbW6hTLoBWPmBP
         qnvwHp6y3hzm49ZsKZkSJhODBsg1vM4/ugn9Evrpv7f2VjoYDcxfs0i9Ls/XYDV08MGh
         8BEA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20221208; t=1684482093; x=1687074093;
        h=content-disposition:mime-version:message-id:subject:to:from:date
         :x-gm-message-state:from:to:cc:subject:date:message-id:reply-to;
        bh=xz++8cp/MOfN7DhrMnTkQuFUltOrCffkRhgTguG3kA8=;
        b=f0zCNdRN0XMep1+Mt5n33rIDSi9r0+KoyXuGQkA17OPbyF35yd/e8ptptAx2HNbMG1
         eF+SC8Bry78ABddMqJj42fr4eFiIgH4HUWS2vzE2MXwZvJNN87z8qIxJDkC2tlTKk0pb
         a53IR6qndq05+MbhUjQ68gdASYr8i/NATHUhzUzdNFx2Jg7FXKLb8FXB3QbKzQxmbVwS
         voZPmuC5KJEmS+RcKQ2NVbGR3Rz0WjS+riyNkMq/ihxqAxAamPbJUXxJ4GkRQ0UWe5Uq
         oJRANINZZ4A9AcSpe8L7ZL3CXP1VPB2UAbyhwUF1QZxdMt4l+ajFxerO95fJdHoEJ3++
         mZBA==
X-Gm-Message-State: AC+VfDxhPSbV2jcpJlqeETSe+YMHowAx5akiv8pkifx0ppnOoCf6/R8Q
        +Kr+TlHbnHMn+PtUe+FOJJC8CDO6WRvuMlrN
X-Google-Smtp-Source: ACHHUZ6riYfWPSPFysHEBQfMeS75lFvnOx9JAEpTac2x0Xug/XU92DVrbyAwpdcPDzxsO3saB8dZyw==
X-Received: by 2002:a05:6a00:1783:b0:644:d77:a2c5 with SMTP id s3-20020a056a00178300b006440d77a2c5mr2161385pfg.29.1684482092509;
        Fri, 19 May 2023 00:41:32 -0700 (PDT)
Received: from yoga ([2400:1f00:13:b468:8a9f:b695:3862:d744])
        by smtp.gmail.com with ESMTPSA id v11-20020aa7808b000000b005d22639b577sm2427908pff.165.2023.05.19.00.41.27
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Fri, 19 May 2023 00:41:32 -0700 (PDT)
Date:   Fri, 19 May 2023 13:11:24 +0530
From:   Anup Sharma <anupnewsmail@gmail.com>
To:     Peter Zijlstra <peterz@infradead.org>,
        Ingo Molnar <mingo@redhat.com>,
        Arnaldo Carvalho de Melo <acme@kernel.org>,
        Mark Rutland <mark.rutland@arm.com>,
        Alexander Shishkin <alexander.shishkin@linux.intel.com>,
        Jiri Olsa <jolsa@kernel.org>,
        Namhyung Kim <namhyung@kernel.org>,
        Ian Rogers <irogers@google.com>,
        Adrian Hunter <adrian.hunter@intel.com>,
        Anup Sharma <anupnewsmail@gmail.com>,
        linux-perf-users@vger.kernel.org, linux-kernel@vger.kernel.org
Subject: [PATCH v2] perf: test: Add support for testing JSON generated by
 perf data command
Message-ID: <ZGcoJBAGlknjsA/n@yoga>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
X-Spam-Status: No, score=-2.1 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,FREEMAIL_FROM,
        RCVD_IN_DNSWL_NONE,SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE
        autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

This commit adds support for testing the JSON output generated
by the perf data command's conversion to JSON functionality.
The test script now includes a validation step to ensure that
the resulting JSON file is contain valid data.

Signed-off-by: Anup Sharma <anupnewsmail@gmail.com>

Changes:
V1 -> V2: Added a check for the existence of the result output file.
          Replaced the usage of jq with json.load for validating the JSON format.
          Checks using ShellCheck and checkpatch, addressing and resolving warnings.
          Removed the unnecessary root permission check.
          Modified the perf record command to avoid requiring root permissions.
---
 .../shell/test_perf_data_converter_json.sh    | 78 +++++++++++++++++++
 1 file changed, 78 insertions(+)
 create mode 100755 tools/perf/tests/shell/test_perf_data_converter_json.sh

diff --git a/tools/perf/tests/shell/test_perf_data_converter_json.sh b/tools/perf/tests/shell/test_perf_data_converter_json.sh
new file mode 100755
index 000000000000..54b7a19962fa
--- /dev/null
+++ b/tools/perf/tests/shell/test_perf_data_converter_json.sh
@@ -0,0 +1,78 @@
+#!/bin/bash
+# perf data json converter command test
+# SPDX-License-Identifier: GPL-2.0
+
+set -e
+
+err=0
+
+if [ "$PYTHON" = "" ]
+then
+	if which python3 > /dev/null
+	then
+		PYTHON=python3
+	elif which python > /dev/null
+	then
+		PYTHON=python
+	else
+		echo Skipping test, python not detected please set environment variable PYTHON.
+		exit 2
+	fi
+fi
+
+perfdata=$(mktemp /tmp/__perf_test.perf.data.XXXXX)
+result=$(mktemp /tmp/__perf_test.output.json.XXXXX)
+
+cleanup()
+{
+	rm -f "${perfdata}"
+	rm -f "${result}"
+	trap - exit term int
+}
+
+trap_cleanup()
+{
+	cleanup
+	exit ${err}
+}
+trap trap_cleanup exit term int
+
+test_json_converter_command()
+{
+	echo "Testing Perf Data Convertion Command to JSON"
+	perf record -o "$perfdata" -F 99 -g -- perf test -w noploop > /dev/null 2>&1
+	perf data convert --to-json "$result" --force -i "$perfdata" >/dev/null 2>&1
+	if [ $(cat "${result}" | wc -l) -gt "0" ]
+	then
+		echo "Perf Data Converter Command to JSON [SUCCESS]"
+	else 
+		echo "Perf Data Converter Command to JSON [FAILED]"
+		err=1
+		exit
+	fi
+}
+
+validate_json_format()
+{
+    echo "Validating Perf Data Converted JSON file"
+    if [ -f "$result" ]
+    then
+        if $PYTHON -c  "import json; json.load(open('$result'))" >/dev/null 2>&1
+	then
+            echo "The file contains valid JSON format [SUCCESS]"
+        else
+            echo "The file does not contain valid JSON format [FAILED]"
+            err=1
+	    exit
+        fi
+    else
+        echo "File not found [FAILED]"
+        err=2
+        exit
+    fi
+}
+
+test_json_converter_command
+validate_json_format
+
+exit ${err}
-- 
2.34.1

