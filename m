Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 8CCC86EAD54
	for <lists+linux-kernel@lfdr.de>; Fri, 21 Apr 2023 16:44:42 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232637AbjDUOoe (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Fri, 21 Apr 2023 10:44:34 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:55124 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232263AbjDUOoc (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 21 Apr 2023 10:44:32 -0400
Received: from smtp-out1.suse.de (smtp-out1.suse.de [IPv6:2001:67c:2178:6::1c])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 578094487
        for <linux-kernel@vger.kernel.org>; Fri, 21 Apr 2023 07:44:02 -0700 (PDT)
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by smtp-out1.suse.de (Postfix) with ESMTPS id 5097C218F2;
        Fri, 21 Apr 2023 14:42:58 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
        t=1682088178; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=FUaHjqwAUBVTmW0O/bwvpnE48ou2UUiRPqDFHCuym3M=;
        b=HVVxQMBS7rq9Ji7T7UJvFhFYmPbIht4wZMdNEBF84t8JM5xqU1wTZYMU3Jxcs6iRt+cA1/
        ztMystp5eKj+sDEMeScBjHAHV/TgUT9MbIc7ihu6b+hs5K1GX3ha8IrrJWpVcP5C8bSvDQ
        Oja3UIfXaxczek1c21m9O4jw26EV7iY=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
        s=susede2_ed25519; t=1682088178;
        h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=FUaHjqwAUBVTmW0O/bwvpnE48ou2UUiRPqDFHCuym3M=;
        b=n+Yb+bt7mR0jXjlxH8/MBdsTegmSosMzwCokv0AmwV8vHfryEZDO4R3+3dU6UxJEiNNRKm
        aKOCCdpkZoEquiCQ==
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by imap2.suse-dmz.suse.de (Postfix) with ESMTPS id 219991390E;
        Fri, 21 Apr 2023 14:42:58 +0000 (UTC)
Received: from dovecot-director2.suse.de ([192.168.254.65])
        by imap2.suse-dmz.suse.de with ESMTPSA
        id 7xoAAfKgQmQpBAAAMHmgww
        (envelope-from <tiwai@suse.de>); Fri, 21 Apr 2023 14:42:58 +0000
Date:   Fri, 21 Apr 2023 16:42:57 +0200
Message-ID: <87wn25qosu.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Chris Down <chris@chrisdown.name>
Cc:     linux-kernel@vger.kernel.org, alsa-devel@alsa-project.org,
        Jaroslav Kysela <perex@perex.cz>, Takashi Iwai <tiwai@suse.com>
Subject: Re: [PATCH] usb-audio: Rate limit usb_set_interface error reporting
In-Reply-To: <ZEKf8UYBYa1h4JWR@chrisdown.name>
References: <ZEKf8UYBYa1h4JWR@chrisdown.name>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/27.2 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-Spam-Status: No, score=-4.4 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_MED,SPF_HELO_NONE,
        SPF_PASS,T_SCC_BODY_TEXT_LINE,URIBL_BLOCKED autolearn=ham
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, 21 Apr 2023 16:38:41 +0200,
Chris Down wrote:
> 
> When an error occurs during USB disconnection sometimes things can go
> wrong as endpoint_set_interface may end up being called repeatedly. For
> example:
> 
> % dmesg --notime | grep 'usb 3-7.1.4' | sort | uniq -c | head -2
>    3069 usb 3-7.1.4: 1:1: usb_set_interface failed (-19)
>     908 usb 3-7.1.4: 1:1: usb_set_interface failed (-71)
> 
> In my case, there sometimes are hundreds of these usb_set_interface
> failure messages a second when I disconnect the hub that has my USB
> audio device.
> 
> These messages can take a huge amount of the kmsg ringbuffer and don't
> provide any extra information over the previous ones, so ratelimit them.
> 
> Signed-off-by: Chris Down <chris@chrisdown.name>

This patch itself is safe and good to have, so I'm going to take it as
is.

But I'm still curious in which code path the problem happens.  That
is, we should address such unnecessary repeats if possible.  Do you
have some more data?


thanks,

Takashi
