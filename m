Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id E441963AA0E
	for <lists+linux-kernel@lfdr.de>; Mon, 28 Nov 2022 14:51:23 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232145AbiK1NvW (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Mon, 28 Nov 2022 08:51:22 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:47414 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231445AbiK1NvR (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 28 Nov 2022 08:51:17 -0500
Received: from smtp-out1.suse.de (smtp-out1.suse.de [195.135.220.28])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id F16EC1EC50
        for <linux-kernel@vger.kernel.org>; Mon, 28 Nov 2022 05:51:16 -0800 (PST)
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by smtp-out1.suse.de (Postfix) with ESMTPS id 9DB4721B8A;
        Mon, 28 Nov 2022 13:51:15 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
        t=1669643475; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=bOLaMPxOUG7+4vSlzBdUMwRrj0JlFA0stWHUkYrEcl0=;
        b=tb4dXBk9E7uOnfLm/jK09MAtSuGeVbvX6bCRzTOUyE+Me+WcmVUbJrEUt6ZzUzTNsyxs8N
        5aFhdfa/4Mrmbt1ih0yhNPrA7a9K9WNqZhwm2ozWl/xNtoF1rjiPstMJS505SiHkNGs6ne
        4LeQy9fB6JEU9HNFyfd5KOuQZyK40sE=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
        s=susede2_ed25519; t=1669643475;
        h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=bOLaMPxOUG7+4vSlzBdUMwRrj0JlFA0stWHUkYrEcl0=;
        b=9n45SyRa82AFe61XqCIG9WmD1Zciit8L0w9BUBrIdwvZ0drp0HlLjsFxRo88uQdEdZ4IMZ
        pNEDcwZyT9/8iGDw==
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by imap2.suse-dmz.suse.de (Postfix) with ESMTPS id 7CCFE1326E;
        Mon, 28 Nov 2022 13:51:15 +0000 (UTC)
Received: from dovecot-director2.suse.de ([192.168.254.65])
        by imap2.suse-dmz.suse.de with ESMTPSA
        id A/2xHdO8hGP/EgAAMHmgww
        (envelope-from <tiwai@suse.de>); Mon, 28 Nov 2022 13:51:15 +0000
Date:   Mon, 28 Nov 2022 14:51:15 +0100
Message-ID: <87lenvyyp8.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     John Keeping <john@metanate.com>
Cc:     alsa-devel@alsa-project.org, Jaroslav Kysela <perex@perex.cz>,
        Takashi Iwai <tiwai@suse.com>, linux-kernel@vger.kernel.org
Subject: Re: [PATCH] ALSA: usb-audio: Add quirk for Tascam Model 12
In-Reply-To: <20221128122353.763696-1-john@metanate.com>
References: <20221128122353.763696-1-john@metanate.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/27.2 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-Spam-Status: No, score=-4.4 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_MED,SPF_HELO_NONE,
        SPF_PASS autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Mon, 28 Nov 2022 13:23:52 +0100,
John Keeping wrote:
> 
> Tascam's Model 12 is a mixer which can also operate as a USB audio
> interface.  The audio interface uses explicit feedback but it seems that
> it does not correctly handle missing isochronous frames.
> 
> When injecting an xrun (or doing anything else that pauses the playback
> stream) the feedback rate climbs (for example, at 44,100Hz nominal, I
> see a stable rate around 44,099 but xrun injection sees this peak at
> around 44,135 in most cases) and glitches are heard in the audio stream
> for several seconds - this is significantly worse than the single glitch
> expected for an underrun.
> 
> While the stream does normally recover and the feedback rate returns to
> a stable value, I have seen some occurrences where this does not happen
> and the rate continues to increase while no audio is heard from the
> output.  I have not found a solid reproduction for this.
> 
> This misbehaviour can be avoided by totally resetting the stream state
> by switching the interface to alt 0 and back before restarting the
> playback stream.
> 
> Add a new quirk flag which forces the endpoint and interface to be
> reconfigured whenever the stream is stopped, and use this for the Tascam
> Model 12.
> 
> Signed-off-by: John Keeping <john@metanate.com>

Thanks for the patch, it's an interesting case.
About the code change:

> --- a/sound/usb/endpoint.c
> +++ b/sound/usb/endpoint.c
> @@ -1673,6 +1673,13 @@ void snd_usb_endpoint_stop(struct snd_usb_endpoint *ep, bool keep_pending)
>  		stop_urbs(ep, false, keep_pending);
>  		if (ep->clock_ref)
>  			atomic_dec(&ep->clock_ref->locked);
> +
> +		if (ep->chip->quirk_flags & QUIRK_FLAG_FORCE_IFACE_RESET &&
> +		    usb_pipeout(ep->pipe)) {
> +			ep->need_setup = true;
> +			if (ep->iface_ref)
> +				ep->iface_ref->need_setup = true;
> +		}

Is this the forced reset always safe?  Imagine that you have
individual playback and capture streams, and what if only one of them
gets stopped and restarted while another keeps running?


thanks,

Takashi
