Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 14058707A0B
	for <lists+linux-kernel@lfdr.de>; Thu, 18 May 2023 08:03:49 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230028AbjERGDr convert rfc822-to-8bit (ORCPT
        <rfc822;lists+linux-kernel@lfdr.de>); Thu, 18 May 2023 02:03:47 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34820 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230022AbjERGDp (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 18 May 2023 02:03:45 -0400
Received: from mail-vk1-f177.google.com (mail-vk1-f177.google.com [209.85.221.177])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C10342696;
        Wed, 17 May 2023 23:03:42 -0700 (PDT)
Received: by mail-vk1-f177.google.com with SMTP id 71dfb90a1353d-4518d3a9b12so628576e0c.2;
        Wed, 17 May 2023 23:03:42 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20221208; t=1684389822; x=1686981822;
        h=content-transfer-encoding:cc:to:subject:message-id:date:from
         :in-reply-to:references:mime-version:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=bXsUEZdg7frRdNYYyqBOXtRmmOUkZTVlUYkUEGA36aE=;
        b=fJ4kV94GZ2rMO4Ej6/kG8/EV4zG7nvKjSmeGl5x1NdMkG2LJRUoJ/Rc9zyyu2WAGlH
         Vk2dMwk/D3uhXKhZGWKuGQg1a/gvqAu/Q6CQZ7xIaGdZbO5IdpPVaD/Yh/Rto2Bov/qJ
         Md2CxXc2n5+Hz10a21m59OjKoy/GGw/rXno/zTyLj1kUDeKgepY8WucMWZfIASnuN6Hg
         y5DX99LuCjAR2N7dfMmEqMIQj5mDAiqqzcGHb514ZB0BiBgW44OFbH27mdF3rou3DwAQ
         RxiNJii9jIKiFs3OwTPB/RNlV6UN7m2Y70+cPqDclZjGWA1XcUwO+RimYb8gCEGh9nTm
         JACg==
X-Gm-Message-State: AC+VfDzgc1XQGYkjlJQjHc9AaY4Nk73M9kiZKBLPtNQ8+fhnP/wSegzh
        1rye6Yc10ZsUiOYXy2TcvAl/LEf/XAfRbsJp3Qc=
X-Google-Smtp-Source: ACHHUZ6/oXnhfnhg3t29UXinWQGl8uAg8QL04e9+ieeNig4sP3DSqOW8qw003vZI9yz2JTLwSxQXWuS70l2PRYg4F/k=
X-Received: by 2002:a1f:5f06:0:b0:453:8a02:8d9 with SMTP id
 t6-20020a1f5f06000000b004538a0208d9mr301432vkb.11.1684389821697; Wed, 17 May
 2023 23:03:41 -0700 (PDT)
MIME-Version: 1.0
References: <ZGUYVjJk2DhX9UrC@yoga> <CAP-5=fX3oLRgUzt6QhN+6bybp_WsS9gCuJ1484hq16FTWc3Dyg@mail.gmail.com>
In-Reply-To: <CAP-5=fX3oLRgUzt6QhN+6bybp_WsS9gCuJ1484hq16FTWc3Dyg@mail.gmail.com>
From:   Namhyung Kim <namhyung@kernel.org>
Date:   Wed, 17 May 2023 23:03:30 -0700
Message-ID: <CAM9d7cgvYEw2xvhnDDiH+HNhbp6Wirbo0T57i-KZy=BL4tJdJA@mail.gmail.com>
Subject: Re: [PATCH] perf: test: Add support for testing JSON generated by
 perf data command
To:     Ian Rogers <irogers@google.com>
Cc:     Anup Sharma <anupnewsmail@gmail.com>,
        Peter Zijlstra <peterz@infradead.org>,
        Ingo Molnar <mingo@redhat.com>,
        Arnaldo Carvalho de Melo <acme@kernel.org>,
        Mark Rutland <mark.rutland@arm.com>,
        Alexander Shishkin <alexander.shishkin@linux.intel.com>,
        Jiri Olsa <jolsa@kernel.org>,
        Adrian Hunter <adrian.hunter@intel.com>,
        linux-perf-users@vger.kernel.org, linux-kernel@vger.kernel.org
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: 8BIT
X-Spam-Status: No, score=-1.4 required=5.0 tests=BAYES_00,
        FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
        RCVD_IN_DNSWL_NONE,RCVD_IN_MSPIKE_H2,SPF_HELO_NONE,SPF_PASS,
        T_SCC_BODY_TEXT_LINE autolearn=no autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hello,

On Wed, May 17, 2023 at 12:57 PM Ian Rogers <irogers@google.com> wrote:
>
> On Wed, May 17, 2023 at 11:09 AM Anup Sharma <anupnewsmail@gmail.com> wrote:
> >
> > This commit adds support for testing the JSON output generated
> > by the perf data command's conversion to JSON functionality.
> > The test script now includes a validation step to ensure that
> > the resulting JSON file is contain valid data.
> >
> > As a newcomer to this community, any feedback on the implementation
> > is highly appreciated.
> >
> > Signed-off-by: Anup Sharma <anupnewsmail@gmail.com>
>
> Congratulations on sending your first patch! Anup is this summer's
> Google Summer-of-Code contributor for the Linux perf tool. I'm sure
> everyone on the lists is looking forward to your contributions!

+1

>
> > ---
> >  .../shell/test_perf_data_converter_json.sh    | 64 +++++++++++++++++++
> >  1 file changed, 64 insertions(+)
> >  create mode 100755 tools/perf/tests/shell/test_perf_data_converter_json.sh
> >
> > diff --git a/tools/perf/tests/shell/test_perf_data_converter_json.sh b/tools/perf/tests/shell/test_perf_data_converter_json.sh
> > new file mode 100755
> > index 000000000000..88db96e38925
> > --- /dev/null
> > +++ b/tools/perf/tests/shell/test_perf_data_converter_json.sh
> > @@ -0,0 +1,64 @@
> > +#!/bin/sh
> > +# perf data json converter test
> > +# SPDX-License-Identifier: GPL-2.0

You may want to run shellcheck when you write a shell script.

> > +
> > +set -e
> > +
> > +err=0
> > +perfdata=$(mktemp /tmp/__perf_test.perf.data.XXXXX)
> > +result=$(mktemp /tmp/__perf_test.output.json.XXXXX)
> > +
> > +cleanup()
> > +{
> > +       rm -f ${perfdata}
> > +       rm -f ${result}
> > +       trap - exit term int
> > +}
> > +
> > +trap_cleanup()
> > +{
> > +       cleanup
> > +       exit ${err}
> > +}
> > +trap trap_cleanup exit term int
> > +
> > +check()
> > +{
> > +       if [ `id -u` != 0 ]; then
> > +               echo "[Skip] No root permission"

I don't think we actually need root permission for this test.

> > +               err=2
> > +               exit
> > +       fi
> > +}
> > +
> > +test_json()
> > +{
> > +       echo "Testing perf data convertion to JSON"
> > +       perf record -o $perfdata -F 99 -a -g -- sleep 1 > /dev/null 2>&1

The -a/--system-wide option requires root permission usually.
We can run perf record in per-task mode instead.  Please remove the -a
option and run some other command instead of 'sleep 1'.  The perf tool
has a couple of test workloads and benchmark programs.  So you can try
something like

  perf record -o $perfdata -F 99 -g -- perf test -w noploop

or

  perf record -o $perfdata -F 99 -g -- perf bench sched messaging

Thanks,
Namhyung


> > +       perf data convert --to-json $result --force -i $perfdata >/dev/null 2>&1
> > +       echo "Perf Data Converter to JSON [SUCCESS]"
> > +}
> > +
> > +validate_json_format()
> > +{
> > +       echo "Testing perf data converted to JSON format"
> > +       if [ -f "${result}" ]; then
>
> It can be a good idea to test for failure and early exit. It would
> avoid being as indented in the following if.
>
> > +               if jq '.' "${result}" > /dev/null 2>&1; then
>
> This assumes the jq program is available and it isn't by default on my
> distribution. We could test:
> if ! which jq; then
> but it may be better to depend on Python and json.loads - Python is
> already a dependency for a number of the tests.
>
> Thanks,
> Ian
>
> > +                   echo "The file contains valid JSON format [SUCCESS]"
> > +               else
> > +                   echo "The file does not contain valid JSON format [FAILED]"
> > +                   err=1
> > +               fi
> > +           else
> > +               echo "File not found [FAILED]"
> > +               err=2
> > +               exit
> > +           fi
> > +}
> > +
> > +check
> > +
> > +test_json
> > +validate_json_format
> > +
> > +exit ${err}
> > --
> > 2.34.1
> >
